<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Procesador de Texture Pack</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    input, textarea { display: block; margin-bottom: 10px; }
    .download-links a { display: block; margin-bottom: 5px; }
  </style>
</head>
<body>
  <h1>Registro de Texture Pack</h1>
  <form id="textureForm">
    <label>
      Nombre del Texture Pack:
      <input type="text" id="textureName" required>
    </label>
    <label>
      Versión:
      <input type="text" id="version" required>
    </label>
    <label>
      Descripción:
      <textarea id="descripcion" rows="3" required></textarea>
    </label>
    <label>
      Color 1:
      <input type="color" id="color1" value="#ff0000">
    </label>
    <label>
      Color 2:
      <input type="color" id="color2" value="#0000ff">
    </label>
    <label>
      Imagen a Redimensionar:
      <input type="file" id="imagenRedimensionar" accept="image/*" required>
    </label>
    <button type="submit">Enviar y Procesar</button>
  </form>

  <div id="resultado" style="margin-top:20px;"></div>
  <div class="download-links" id="downloadLinks"></div>

  <script>
function applyHSBToImage(image, hsb) {
  const canvas = document.createElement('canvas');
  canvas.width = 450;
  canvas.height = 450;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(image, 0, 0, 450, 450);

  const imageData = ctx.getImageData(0, 0, 450, 450);
  const data = imageData.data;

  const h = parseFloat(hsb.hue);
  const s = parseFloat(hsb.saturation) / 100;
  const b = parseFloat(hsb.brightness) / 100;

  for (let i = 0; i < data.length; i += 4) {
    // Convert RGB to HSB
    const r = data[i] / 255;
    const g = data[i + 1] / 255;
    const bOld = data[i + 2] / 255;

    const max = Math.max(r, g, bOld);
    const min = Math.min(r, g, bOld);
    const delta = max - min;

    let hue = 0;
    let sat = max === 0 ? 0 : delta / max;
    let bri = max;

    if (delta !== 0) {
      if (max === r) hue = 60 * (((g - bOld) / delta) % 6);
      else if (max === g) hue = 60 * (((bOld - r) / delta) + 2);
      else hue = 60 * (((r - g) / delta) + 4);
    }

    if (hue < 0) hue += 360;

    // Replace with provided H, S, B
    const newRGB = hsbToRgb(h, s, b);
    data[i] = newRGB.r;
    data[i + 1] = newRGB.g;
    data[i + 2] = newRGB.b;
  }

  ctx.putImageData(imageData, 0, 0);
  return canvas;
}

function hsbToRgb(h, s, v) {
  const c = v * s;
  const x = c * (1 - Math.abs((h / 60) % 2 - 1));
  const m = v - c;
  let r, g, b;

  if (h < 60) [r, g, b] = [c, x, 0];
  else if (h < 120) [r, g, b] = [x, c, 0];
  else if (h < 180) [r, g, b] = [0, c, x];
  else if (h < 240) [r, g, b] = [0, x, c];
  else if (h < 300) [r, g, b] = [x, 0, c];
  else [r, g, b] = [c, 0, x];

  return {
    r: Math.round((r + m) * 255),
    g: Math.round((g + m) * 255),
    b: Math.round((b + m) * 255)
  };
}
    
    function hsbFromHex(hex) {
      if(hex.charAt(0) === '#') hex = hex.substr(1);
      const r = parseInt(hex.substr(0,2), 16) / 255;
      const g = parseInt(hex.substr(2,2), 16) / 255;
      const b = parseInt(hex.substr(4,2), 16) / 255;
      const max = Math.max(r, g, b);
      const min = Math.min(r, g, b);
      const delta = max - min;
      const brightness = max;
      const saturation = (max === 0) ? 0 : delta / max;
      let hue = 0;
      if(delta !== 0) {
        if(max === r) hue = 60 * (((g - b) / delta) % 6);
        else if(max === g) hue = 60 * (((b - r) / delta) + 2);
        else if(max === b) hue = 60 * (((r - g) / delta) + 4);
      }
      if(hue < 0) hue += 360;
      return {
        hue: hue.toFixed(2),
        saturation: (saturation * 100).toFixed(2),
        brightness: (brightness * 100).toFixed(2)
      };
    }

    function resizeImage(img, width, height) {
      const canvas = document.createElement('canvas');
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, width, height);
      return canvas;
    }

    function loadImage(src) {
      return new Promise((resolve) => {
        const img = new Image();
        img.src = src;
        img.onload = () => resolve(img);
      });
    }

    function createVerticalComposite(images) {
      const canvas = document.createElement('canvas');
      canvas.width = 450;
      canvas.height = 450;
      const ctx = canvas.getContext('2d');

      images.forEach((img) => {
        ctx.drawImage(img, 0, 0, 450, 450);
      });

      return canvas;
    }

    function applyHSBForImage(){
      
    }

    document.getElementById('textureForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const textureName = document.getElementById('textureName').value;
      const version = document.getElementById('version').value;
      const descripcion = document.getElementById('descripcion').value;
      const color1 = document.getElementById('color1').value;
      const color2 = document.getElementById('color2').value;
      const imagenFile = document.getElementById('imagenRedimensionar').files[0];

      const color1HSB = hsbFromHex(color1);
      const color2HSB = hsbFromHex(color2);

      const resultadoDiv = document.getElementById('resultado');
      resultadoDiv.innerHTML = `
        <h3>Resultados del Cálculo de Colores</h3>
        <p>Color 1: HUE: ${color1HSB.hue}°, Saturación: ${color1HSB.saturation}%, Brillo: ${color1HSB.brightness}%</p>
        <p>Color 2: HUE: ${color2HSB.hue}°, Saturación: ${color2HSB.saturation}%, Brillo: ${color2HSB.brightness}%</p>
      `;

      const userImg = new Image();
      const reader = new FileReader();
      reader.onload = function(event) {
        userImg.src = event.target.result;
      }
      reader.readAsDataURL(imagenFile);

      userImg.onload = async function() {
        const resizedUserImg = resizeImage(userImg, 450, 450);

        const images03 = await Promise.all([
          loadImage('./resources/base_color/GJ_Gamesheet03.png'),
          loadImage('./resources/principal_color/GJ_Gamesheet031.png'),
          loadImage('./resources/secondary_color/GJ_Gamesheet032.png')
        ]);

        const composite03 = createVerticalComposite(images03);

        const jsonBlob = new Blob([JSON.stringify({ nombre: textureName, version, descripcion }, null, 2)], {type: 'application/json'});
        const jsonURL = URL.createObjectURL(jsonBlob);
        const resizedURL = resizedUserImg.toDataURL('image/png');
        const composite03URL = composite03.toDataURL('image/png');

        const downloadDiv = document.getElementById('downloadLinks');
        downloadDiv.innerHTML = `
          <h3>Descargar Archivos</h3>
          <a href="${jsonURL}" download="texture_info.json">Descargar JSON</a>
          <a href="${resizedURL}" download="imagen_redimensionada.png">Descargar Imagen Redimensionada</a>
          <a href="${composite03URL}" download="imagen_combinada_03.png">Descargar Imagen Combinada 03</a>
        `;

        resultadoDiv.innerHTML += `<h3>Imagen Redimensionada</h3><img src="${resizedURL}" alt="Redimensionada">`;
        resultadoDiv.innerHTML += `<h3>Imagen Combinada 03</h3><img src="${composite03URL}" alt="Combinada 03">`;
      };
    });
  </script>
</body>
</html>
